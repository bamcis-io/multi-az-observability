"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BasicServiceDashboard = void 0;
const aws_cloudwatch_1 = require("aws-cdk-lib/aws-cloudwatch");
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
class BasicServiceDashboard extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        let widgets = [];
        widgets.push(BasicServiceDashboard.createTopLevelAlarmWidgets(props.zonalAggregateIsolatedImpactAlarms));
        if (props.zonalLoadBalancerIsolatedImpactAlarms !== undefined && props.zonalLoadBalancerFaultRateMetrics !== undefined) {
            widgets.push(BasicServiceDashboard.createLoadBalancerWidgets(props.zonalLoadBalancerIsolatedImpactAlarms, props.zonalLoadBalancerFaultRateMetrics));
        }
        if (props.zonalNatGatewayIsolatedImpactAlarms !== undefined && props.zonalNatGatewayPacketDropMetrics !== undefined) {
            widgets.push(BasicServiceDashboard.createNatGatewayWidgets(props.zonalNatGatewayIsolatedImpactAlarms, props.zonalNatGatewayPacketDropMetrics));
        }
        this.dashboard = new aws_cloudwatch_1.Dashboard(this, "BasicServiceDashboard", {
            dashboardName: props.serviceName.toLowerCase() + aws_cdk_lib_1.Fn.sub("-service-${AWS::Region}"),
            defaultInterval: props.interval,
            periodOverride: aws_cloudwatch_1.PeriodOverride.INHERIT,
            widgets: widgets
        });
    }
    static createLoadBalancerWidgets(alarms, metrics) {
        let widgets = [];
        widgets.push(new aws_cloudwatch_1.TextWidget({
            markdown: "Load Balancer Fault Count Metrics",
            height: 2,
            width: 24
        }));
        let rowTracker = 0;
        Object.keys(alarms).forEach((availabilityZoneId, index) => {
            widgets.push(new aws_cloudwatch_1.GraphWidget({
                height: 6,
                width: 8,
                title: availabilityZoneId + " Load Balancer Faults",
                region: aws_cdk_lib_1.Fn.sub("${AWS::Region}"),
                left: [
                    metrics[availabilityZoneId]
                ],
                statistic: "Sum",
                leftYAxis: {
                    min: 0,
                    label: "Fault Count",
                    showUnits: false
                }
            }));
            //We're on the third one for this set, add 3 alarms
            //or if we're at the end, at the necessary amount
            //of alarms, 1, 2, or 3
            if (index % 3 == 2 || index - 1 == Object.keys(alarms).length) {
                for (let k = rowTracker; k <= index; k++) {
                    widgets.push(new aws_cloudwatch_1.AlarmWidget({
                        height: 2,
                        width: 8,
                        region: aws_cdk_lib_1.Fn.sub("${AWS::Region}"),
                        alarm: alarms[availabilityZoneId]
                    }));
                }
                rowTracker += index + 1;
            }
        });
        return widgets;
    }
    static createNatGatewayWidgets(alarms, metrics) {
        let widgets = [];
        widgets.push(new aws_cloudwatch_1.TextWidget({
            markdown: "NAT Gateway Dropped Packet Metrics",
            height: 2,
            width: 24
        }));
        let rowTracker = 0;
        Object.keys(alarms).forEach((availabilityZoneId, index) => {
            widgets.push(new aws_cloudwatch_1.GraphWidget({
                height: 6,
                width: 8,
                title: availabilityZoneId + " NAT Gateway Dropped Packets",
                region: aws_cdk_lib_1.Fn.sub("${AWS::Region}"),
                left: [
                    metrics[availabilityZoneId]
                ],
                statistic: "Sum",
                leftYAxis: {
                    min: 0,
                    label: "Dropped packets",
                    showUnits: false
                }
            }));
            //We're on the third one for this set, add 3 alarms
            //or if we're at the end, at the necessary amount
            //of alarms, 1, 2, or 3
            if (index % 3 == 2 || index - 1 == Object.keys(alarms).length) {
                for (let k = rowTracker; k <= index; k++) {
                    widgets.push(new aws_cloudwatch_1.AlarmWidget({
                        height: 2,
                        width: 8,
                        region: aws_cdk_lib_1.Fn.sub("${AWS::Region}"),
                        alarm: alarms[availabilityZoneId]
                    }));
                }
                rowTracker += index + 1;
            }
        });
        return widgets;
    }
    static createTopLevelAlarmWidgets(alarms) {
        let widgets = [];
        widgets.push(new aws_cloudwatch_1.TextWidget({
            markdown: "Availability Zone Isolated Impact Alarms",
            height: 2,
            width: 24
        }));
        Object.keys(alarms).forEach(availabilityZoneId => {
            widgets.push(new aws_cloudwatch_1.AlarmStatusWidget({
                alarms: [alarms[availabilityZoneId]],
                height: 2,
                width: 8,
                title: availabilityZoneId + " Aggregate Isolated Impact"
            }));
        });
        return widgets;
    }
}
exports.BasicServiceDashboard = BasicServiceDashboard;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmFzaWNTZXJ2aWNlRGFzaGJvYXJkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQmFzaWNTZXJ2aWNlRGFzaGJvYXJkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtEQUEwSjtBQUMxSiwyQ0FBdUM7QUFFdkMsNkNBQWlDO0FBRWpDLE1BQWEscUJBQXNCLFNBQVEsc0JBQVM7SUFJaEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFpQztRQUV2RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksT0FBTyxHQUFnQixFQUFFLENBQUM7UUFFOUIsT0FBTyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQyxDQUFDO1FBRXpHLElBQUksS0FBSyxDQUFDLHFDQUFxQyxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsaUNBQWlDLEtBQUssU0FBUyxFQUN0SCxDQUFDO1lBQ0csT0FBTyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMscUNBQXFDLEVBQUUsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUMsQ0FBQztRQUN4SixDQUFDO1FBRUQsSUFBSSxLQUFLLENBQUMsbUNBQW1DLEtBQUssU0FBUyxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsS0FBSyxTQUFTLEVBQ25ILENBQUM7WUFDRyxPQUFPLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLHVCQUF1QixDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsRUFBRSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQyxDQUFBO1FBQ2xKLENBQUM7UUFFRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksMEJBQVMsQ0FBQyxJQUFJLEVBQUUsdUJBQXVCLEVBQUU7WUFDMUQsYUFBYSxFQUFFLEtBQUssQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLEdBQUcsZ0JBQUUsQ0FB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Q1osQ0FBQyxDQUFDLENBQUM7UUFFSixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFO1lBQzdDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxrQ0FBaUIsQ0FBQztnQkFDL0IsTUFBTSxFQUFFLENBQUUsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUU7Z0JBQ3RDLE1BQU0sRUFBRSxDQUFDO2dCQUNULEtBQUssRUFBRSxDQUFDO2dCQUNSLEtBQUssRUFBRSxrQkFBa0IsR0FBRyw0QkFBNEI7YUFDM0QsQ0FBQyxDQUFDLENBQUE7UUFDUCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7Q0FDSjtBQTlKRCxzREE4SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbGFybVN0YXR1c1dpZGdldCwgQWxhcm1XaWRnZXQsIERhc2hib2FyZCwgR3JhcGhXaWRnZXQsIElBbGFybSwgSU1ldHJpYywgSVdpZGdldCwgUGVyaW9kT3ZlcnJpZGUsIFRleHRXaWRnZXQgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWNsb3Vkd2F0Y2hcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBCYXNpY1NlcnZpY2VEYXNoYm9hcmRQcm9wcyB9IGZyb20gXCIuL3Byb3BzL0Jhc2ljU2VydmljZURhc2hib2FyZFByb3BzXCI7XG5pbXBvcnQgeyBGbiB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuXG5leHBvcnQgY2xhc3MgQmFzaWNTZXJ2aWNlRGFzaGJvYXJkIGV4dGVuZHMgQ29uc3RydWN0XG57XG4gICAgZGFzaGJvYXJkOiBEYXNoYm9hcmQ7XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQmFzaWNTZXJ2aWNlRGFzaGJvYXJkUHJvcHMpXG4gICAge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgICAgIGxldCB3aWRnZXRzOiBJV2lkZ2V0W11bXSA9IFtdO1xuXG4gICAgICAgIHdpZGdldHMucHVzaChCYXNpY1NlcnZpY2VEYXNoYm9hcmQuY3JlYXRlVG9wTGV2ZWxBbGFybVdpZGdldHMocHJvcHMuem9uYWxBZ2dyZWdhdGVJc29sYXRlZEltcGFjdEFsYXJtcykpO1xuXG4gICAgICAgIGlmIChwcm9wcy56b25hbExvYWRCYWxhbmNlcklzb2xhdGVkSW1wYWN0QWxhcm1zICE9PSB1bmRlZmluZWQgJiYgcHJvcHMuem9uYWxMb2FkQmFsYW5jZXJGYXVsdFJhdGVNZXRyaWNzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHtcbiAgICAgICAgICAgIHdpZGdldHMucHVzaChCYXNpY1NlcnZpY2VEYXNoYm9hcmQuY3JlYXRlTG9hZEJhbGFuY2VyV2lkZ2V0cyhwcm9wcy56b25hbExvYWRCYWxhbmNlcklzb2xhdGVkSW1wYWN0QWxhcm1zLCBwcm9wcy56b25hbExvYWRCYWxhbmNlckZhdWx0UmF0ZU1ldHJpY3MpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwcm9wcy56b25hbE5hdEdhdGV3YXlJc29sYXRlZEltcGFjdEFsYXJtcyAhPT0gdW5kZWZpbmVkICYmIHByb3BzLnpvbmFsTmF0R2F0ZXdheVBhY2tldERyb3BNZXRyaWNzICE9PSB1bmRlZmluZWQpXG4gICAgICAgIHtcbiAgICAgICAgICAgIHdpZGdldHMucHVzaChCYXNpY1NlcnZpY2VEYXNoYm9hcmQuY3JlYXRlTmF0R2F0ZXdheVdpZGdldHMocHJvcHMuem9uYWxOYXRHYXRld2F5SXNvbGF0ZWRJbXBhY3RBbGFybXMsIHByb3BzLnpvbmFsTmF0R2F0ZXdheVBhY2tldERyb3BNZXRyaWNzKSlcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGFzaGJvYXJkID0gbmV3IERhc2hib2FyZCh0aGlzLCBcIkJhc2ljU2VydmljZURhc2hib2FyZFwiLCB7XG4gICAgICAgICAgICBkYXNoYm9hcmROYW1lOiBwcm9wcy5zZXJ2aWNlTmFtZS50b0xvd2VyQ2FzZSgpICsgRm4uc3ViKFwiLXNlcnZpY2UtJHtBV1M6OlJlZ2lvbn1cIiksXG4gICAgICAgICAgICBkZWZhdWx0SW50ZXJ2YWw6IHByb3BzLmludGVydmFsLFxuICAgICAgICAgICAgcGVyaW9kT3ZlcnJpZGU6IFBlcmlvZE92ZXJyaWRlLklOSEVSSVQsXG4gICAgICAgICAgICB3aWRnZXRzOiB3aWRnZXRzXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGNyZWF0ZUxvYWRCYWxhbmNlcldpZGdldHMoYWxhcm1zOiB7W2tleTogc3RyaW5nXTogSUFsYXJtfSwgbWV0cmljczoge1trZXk6IHN0cmluZ106IElNZXRyaWN9KTogSVdpZGdldFtdXG4gICAge1xuICAgICAgICBsZXQgd2lkZ2V0czogSVdpZGdldFtdID0gW107XG5cbiAgICAgICAgd2lkZ2V0cy5wdXNoKG5ldyBUZXh0V2lkZ2V0KHtcbiAgICAgICAgICAgIG1hcmtkb3duOiBcIkxvYWQgQmFsYW5jZXIgRmF1bHQgQ291bnQgTWV0cmljc1wiLFxuICAgICAgICAgICAgaGVpZ2h0OiAyLFxuICAgICAgICAgICAgd2lkdGg6IDI0XG4gICAgICAgIH0pKTtcblxuICAgICAgICBsZXQgcm93VHJhY2tlcjogbnVtYmVyID0gMDtcblxuICAgICAgICBPYmplY3Qua2V5cyhhbGFybXMpLmZvckVhY2goKGF2YWlsYWJpbGl0eVpvbmVJZCwgaW5kZXgpID0+IHtcblxuICAgICAgICAgICAgd2lkZ2V0cy5wdXNoKG5ldyBHcmFwaFdpZGdldCh7XG4gICAgICAgICAgICAgICAgaGVpZ2h0OiA2LFxuICAgICAgICAgICAgICAgIHdpZHRoOiA4LFxuICAgICAgICAgICAgICAgIHRpdGxlOiBhdmFpbGFiaWxpdHlab25lSWQgKyBcIiBMb2FkIEJhbGFuY2VyIEZhdWx0c1wiLFxuICAgICAgICAgICAgICAgIHJlZ2lvbjogRm4uc3ViKFwiJHtBV1M6OlJlZ2lvbn1cIiksXG4gICAgICAgICAgICAgICAgbGVmdDogW1xuICAgICAgICAgICAgICAgICAgIG1ldHJpY3NbYXZhaWxhYmlsaXR5Wm9uZUlkXVxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgc3RhdGlzdGljOiBcIlN1bVwiLFxuICAgICAgICAgICAgICAgIGxlZnRZQXhpczoge1xuICAgICAgICAgICAgICAgICAgICBtaW46IDAsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiBcIkZhdWx0IENvdW50XCIsXG4gICAgICAgICAgICAgICAgICAgIHNob3dVbml0czogZmFsc2VcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIC8vV2UncmUgb24gdGhlIHRoaXJkIG9uZSBmb3IgdGhpcyBzZXQsIGFkZCAzIGFsYXJtc1xuICAgICAgICAgICAgLy9vciBpZiB3ZSdyZSBhdCB0aGUgZW5kLCBhdCB0aGUgbmVjZXNzYXJ5IGFtb3VudFxuICAgICAgICAgICAgLy9vZiBhbGFybXMsIDEsIDIsIG9yIDNcbiAgICAgICAgICAgIGlmIChpbmRleCAlIDMgPT0gMiB8fCBpbmRleCAtIDEgPT0gT2JqZWN0LmtleXMoYWxhcm1zKS5sZW5ndGgpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IHJvd1RyYWNrZXI7IGsgPD0gaW5kZXg7IGsrKylcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHdpZGdldHMucHVzaChuZXcgQWxhcm1XaWRnZXQoeyBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDIsIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiA4LCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWdpb246IEZuLnN1YihcIiR7QVdTOjpSZWdpb259XCIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsYXJtOiBhbGFybXNbYXZhaWxhYmlsaXR5Wm9uZUlkXSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApKTsgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcm93VHJhY2tlciArPSBpbmRleCArIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgcmV0dXJuIHdpZGdldHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlTmF0R2F0ZXdheVdpZGdldHMoYWxhcm1zOiB7W2tleTogc3RyaW5nXTogSUFsYXJtfSwgbWV0cmljczoge1trZXk6IHN0cmluZ106IElNZXRyaWN9KTogSVdpZGdldFtdXG4gICAge1xuICAgICAgICBsZXQgd2lkZ2V0czogSVdpZGdldFtdID0gW107XG5cbiAgICAgICAgd2lkZ2V0cy5wdXNoKG5ldyBUZXh0V2lkZ2V0KHtcbiAgICAgICAgICAgIG1hcmtkb3duOiBcIk5BVCBHYXRld2F5IERyb3BwZWQgUGFja2V0IE1ldHJpY3NcIixcbiAgICAgICAgICAgIGhlaWdodDogMixcbiAgICAgICAgICAgIHdpZHRoOiAyNFxuICAgICAgICB9KSk7XG5cbiAgICAgICAgbGV0IHJvd1RyYWNrZXI6IG51bWJlciA9IDA7XG5cbiAgICAgICAgT2JqZWN0LmtleXMoYWxhcm1zKS5mb3JFYWNoKChhdmFpbGFiaWxpdHlab25lSWQsIGluZGV4KSA9PiB7XG5cbiAgICAgICAgICAgIHdpZGdldHMucHVzaChuZXcgR3JhcGhXaWRnZXQoe1xuICAgICAgICAgICAgICAgIGhlaWdodDogNixcbiAgICAgICAgICAgICAgICB3aWR0aDogOCxcbiAgICAgICAgICAgICAgICB0aXRsZTogYXZhaWxhYmlsaXR5Wm9uZUlkICsgXCIgTkFUIEdhdGV3YXkgRHJvcHBlZCBQYWNrZXRzXCIsXG4gICAgICAgICAgICAgICAgcmVnaW9uOiBGbi5zdWIoXCIke0FXUzo6UmVnaW9ufVwiKSxcbiAgICAgICAgICAgICAgICBsZWZ0OiBbXG4gICAgICAgICAgICAgICAgICAgbWV0cmljc1thdmFpbGFiaWxpdHlab25lSWRdXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBzdGF0aXN0aWM6IFwiU3VtXCIsXG4gICAgICAgICAgICAgICAgbGVmdFlBeGlzOiB7XG4gICAgICAgICAgICAgICAgICAgIG1pbjogMCxcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IFwiRHJvcHBlZCBwYWNrZXRzXCIsXG4gICAgICAgICAgICAgICAgICAgIHNob3dVbml0czogZmFsc2VcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIC8vV2UncmUgb24gdGhlIHRoaXJkIG9uZSBmb3IgdGhpcyBzZXQsIGFkZCAzIGFsYXJtc1xuICAgICAgICAgICAgLy9vciBpZiB3ZSdyZSBhdCB0aGUgZW5kLCBhdCB0aGUgbmVjZXNzYXJ5IGFtb3VudFxuICAgICAgICAgICAgLy9vZiBhbGFybXMsIDEsIDIsIG9yIDNcbiAgICAgICAgICAgIGlmIChpbmRleCAlIDMgPT0gMiB8fCBpbmRleCAtIDEgPT0gT2JqZWN0LmtleXMoYWxhcm1zKS5sZW5ndGgpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IHJvd1RyYWNrZXI7IGsgPD0gaW5kZXg7IGsrKylcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHdpZGdldHMucHVzaChuZXcgQWxhcm1XaWRnZXQoeyBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDIsIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiA4LCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWdpb246IEZuLnN1YihcIiR7QVdTOjpSZWdpb259XCIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsYXJtOiBhbGFybXNbYXZhaWxhYmlsaXR5Wm9uZUlkXSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApKTsgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcm93VHJhY2tlciArPSBpbmRleCArIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB3aWRnZXRzO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGNyZWF0ZVRvcExldmVsQWxhcm1XaWRnZXRzKGFsYXJtczoge1trZXk6IHN0cmluZ106IElBbGFybX0pOiBJV2lkZ2V0W11cbiAgICB7XG4gICAgICAgIGxldCB3aWRnZXRzOiBJV2lkZ2V0W10gPSBbXTtcblxuICAgICAgICB3aWRnZXRzLnB1c2gobmV3IFRleHRXaWRnZXQoe1xuICAgICAgICAgICAgbWFya2Rvd246IFwiQXZhaWxhYmlsaXR5IFpvbmUgSXNvbGF0ZWQgSW1wYWN0IEFsYXJtc1wiLFxuICAgICAgICAgICAgaGVpZ2h0OiAyLFxuICAgICAgICAgICAgd2lkdGg6IDI0XG4gICAgICAgIH0pKTtcblxuICAgICAgICBPYmplY3Qua2V5cyhhbGFybXMpLmZvckVhY2goYXZhaWxhYmlsaXR5Wm9uZUlkID0+IHtcbiAgICAgICAgICAgIHdpZGdldHMucHVzaChuZXcgQWxhcm1TdGF0dXNXaWRnZXQoe1xuICAgICAgICAgICAgICAgIGFsYXJtczogWyBhbGFybXNbYXZhaWxhYmlsaXR5Wm9uZUlkXSBdLFxuICAgICAgICAgICAgICAgIGhlaWdodDogMixcbiAgICAgICAgICAgICAgICB3aWR0aDogOCxcbiAgICAgICAgICAgICAgICB0aXRsZTogYXZhaWxhYmlsaXR5Wm9uZUlkICsgXCIgQWdncmVnYXRlIElzb2xhdGVkIEltcGFjdFwiXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHdpZGdldHM7XG4gICAgfVxufVxuIl19